
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.8">
    
    
      
        <title>DAG Development Tutorial - TYPHOON</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.644de097.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="typhoon" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dag-development-tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="TYPHOON" class="md-header__button md-logo" aria-label="TYPHOON" data-md-component="logo">
      
  <img src="../img/typhoon_flat_icon_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TYPHOON
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DAG Development Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/typhoon-data-org/typhoon-orchestrator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../getting-started/installation/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../examples/hello-world/" class="md-tabs__link">
        Example Walkthroughs
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../usage/dag-context/" class="md-tabs__link">
        Usage
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="TYPHOON" class="md-nav__button md-logo" aria-label="TYPHOON" data-md-component="logo">
      
  <img src="../img/typhoon_flat_icon_white.png" alt="logo">

    </a>
    TYPHOON
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/typhoon-data-org/typhoon-orchestrator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/hello-world/" class="md-nav__link">
        Hello World
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/typhoon-cli/" class="md-nav__link">
        Typhoon Cli
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/creating-a-dag/" class="md-nav__link">
        Creating your DAG
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/connections/" class="md-nav__link">
        Adding connections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/deployment/" class="md-nav__link">
        Deployment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/using-components/" class="md-nav__link">
        Using Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/using-component-ui/" class="md-nav__link">
        Component UI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/creating-hooks/" class="md-nav__link">
        New Hooks (connections)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/typhoon-shell/" class="md-nav__link">
        Typhoon Shell
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Example Walkthroughs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Example Walkthroughs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Example Walkthroughs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/hello-world/" class="md-nav__link">
        Hello World
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/mysql-to-snowflake/" class="md-nav__link">
        MySql to Snowflake
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/pandas-examples/" class="md-nav__link">
        Pandas automation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/favorite_author_extended/" class="md-nav__link">
        Favorite Author Extended
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/dag-context/" class="md-nav__link">
        Dag Context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/py-multistep/" class="md-nav__link">
        !Py & !Multistep
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/task-flow-control/" class="md-nav__link">
        Task flow control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/task-testing/" class="md-nav__link">
        Task testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/functions/" class="md-nav__link">
        Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/transformations/" class="md-nav__link">
        Transformations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/components/" class="md-nav__link">
        Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/hooks/" class="md-nav__link">
        Hooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/templates/" class="md-nav__link">
        Variables & Templates
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions-and-transformations" class="md-nav__link">
    Functions and transformations
  </a>
  
    <nav class="md-nav" aria-label="Functions and transformations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reading-from-a-directory" class="md-nav__link">
    Reading from a directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#counting-number-of-lines" class="md-nav__link">
    Counting number of lines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#writing-to-sqlite" class="md-nav__link">
    Writing to SQLite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dag" class="md-nav__link">
    DAG
  </a>
  
    <nav class="md-nav" aria-label="DAG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-representation" class="md-nav__link">
    Graph representation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dag-code" class="md-nav__link">
    DAG Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-edges" class="md-nav__link">
    Testing the edges
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-dag" class="md-nav__link">
    Running the DAG
  </a>
  
    <nav class="md-nav" aria-label="Running the DAG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-sqlite-table" class="md-nav__link">
    Creating the SQLite table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dag-run" class="md-nav__link">
    DAG run
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-results" class="md-nav__link">
    Checking results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="dag-development-tutorial">DAG Development Tutorial</h1>
<p>Let's start from scratch with a very basic DAG. Every hour we will read all the files under the directory <code>/tmp/typhoon/landing/</code>, count the number of words and write that number in a SQLite database. The SQLite table we write to will have the following shape:</p>
<table>
<thead>
<tr>
<th>file_name</th>
<th>num_words</th>
<th>ts</th>
</tr>
</thead>
<tbody>
<tr>
<td>a.txt</td>
<td>13</td>
<td>2020-01-06T13:01:15</td>
</tr>
<tr>
<td>b.txt</td>
<td>20</td>
<td>2020-01-06T13:01:17</td>
</tr>
<tr>
<td>c.txt</td>
<td>10</td>
<td>2020-01-06T13:01:19</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Learning example</p>
<p>This is just an example for learning purposes. In a production deployment this would not be a useful DAG since in a Lambda instance there won't be any data under <code>tmp</code>. We also won't be able to retrieve the SQLite database because it's persisted to a local file, which will disappear once the lambda finishes running.</p>
<p>However, it is still a good example to learn the basics in a local environment as it's a simple example and not that far off from real applications. Just replace the function that reads locally with a function that reads from an FTP location and the function that writes to SQLite with a function that writes to any other remote database.</p>
</div>
<h2 id="functions-and-transformations">Functions and transformations</h2>
<p>When trying to solve a problem in python it is useful to write some functions and test them until we get our solution right, whether it is in a jupyter notebook or REPL. Typhoon encourages this kind of interactive development as we can trivially incorporate these functions into our DAGs.</p>
<h3 id="reading-from-a-directory">Reading from a directory</h3>
<p>Our first function will search inside a directory and yield the <code>.txt</code> file paths in batches:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">get_files_in_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.txt&#39;</span><span class="p">))</span>
</code></pre></div>
<p>Let's place this code inside a file called <code>functions/tutorial.py</code>.</p>
<div class="admonition info">
<p class="admonition-title">Pathlib</p>
<p>If this is the first time you see the pathlib library <a href="https://docs.python.org/3/library/pathlib.html">check it out</a>, it is one of the nicest additions to Python 3.</p>
</div>
<h3 id="counting-number-of-lines">Counting number of lines</h3>
<p>Given a file path we will read it and count the number of words in it. A naive implementation might be the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">words_in_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="n">num_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">num_words</span>
</code></pre></div>
<p>We just split the contents when there's one or more separators and count the length of the resulting list. Notice that we also returned the file_path as well as the number of words, since it's likely that we will need it upstream. This is a common and useful pattern in Typhoon functions.</p>
<p>Let's also place this code inside the previous file called <code>functions/tutorial.py</code>.</p>
<h3 id="writing-to-sqlite">Writing to SQLite</h3>
<p>Once we have this information we want to write it to a SQLite table in <code>tmp/typhoon/tutorial.db</code> that we will call <code>typhoon_tutorial</code>. However if we write a function that does exactly that there's very little chance we will ever use it again. With very little effort we can make a function that can execute any query against a SQLite database. This is much more likely to be useful in the future.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>

<span class="k">def</span> <span class="nf">execute_on_sqlite</span><span class="p">(</span><span class="n">sqlite_db</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sqlite_db</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>Finally we will also place this code inside the previous file called <code>functions/tutorial.py</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Split functions in different files</p>
<p>Usually we would split functions in files that are descriptive of what they do so they are organised in modules. Eg: <code>filesystem.get_files_in_directory</code>. Since this is just a tutorial we keep them in the same file for simplicity.</p>
</div>
<h3 id="testing">Testing</h3>
<p>As you may have noticed, the fact that we wrote our code as regular python functions that just take some parameters and return some values means that it is trivially testable. Our testing framework of choice for this example is Pytest, but any other framework would work equally well.</p>
<div class="admonition note">
<p class="admonition-title">"Pure" functions</p>
<p>We can't say that our functions are pure in the strict meaning of the term since they have side effects, but they share some advantages such as having no global state and being repeatable as much as possible (ie: given the same input returning the same output).</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">functions.tutorial</span> <span class="kn">import</span> <span class="n">get_files_in_directory</span><span class="p">,</span> <span class="n">words_in_file</span><span class="p">,</span> <span class="n">execute_on_sqlite</span>

<span class="k">def</span> <span class="nf">test_get_files_in_directory</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">file1</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s1">&#39;a.txt&#39;</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
    <span class="n">file2</span> <span class="o">=</span> <span class="n">tmp_path</span> <span class="o">/</span> <span class="s1">&#39;b.txt&#39;</span>
    <span class="n">file2</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_files_in_directory</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)))</span> <span class="o">==</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">file1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">file2</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">test_words_in_file</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">test_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp_path</span> <span class="o">/</span> <span class="s1">&#39;a.txt&#39;</span><span class="p">)</span>
    <span class="n">test_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;To be, or not to be, that is the question&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">words_in_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">test_file</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">test_file</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_execute_on_sqlite</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">):</span>
    <span class="n">sqlite_db</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp_path</span><span class="o">/</span><span class="s1">&#39;test.db&#39;</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sqlite_db</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE stocks</span>
<span class="s1">             (date text, trans text, symbol text, qty real, price real)&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">insert_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;INSERT INTO stocks VALUES (?,?,?,?,?)&#39;&#39;&#39;</span>
    <span class="n">insert_query_params</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;2006-01-05&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;RHAR&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mf">35.14</span><span class="p">)</span>
    <span class="n">execute_on_sqlite</span><span class="p">(</span><span class="n">sqlite_db</span><span class="p">,</span> <span class="n">insert_query</span><span class="p">,</span> <span class="n">insert_query_params</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM stocks&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="o">==</span> <span class="n">insert_query_params</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p>We can create directory <code>tests/</code> and put it in a file named <code>tutorial_tests.py</code>. Run them with <code>pytest</code> and check that they pass. Now we can be confident that our functions work as intended.</p>
<div class="admonition info">
<p class="admonition-title">Running tests</p>
<p>To run the tests go to the base directory of the Typhoon project and run <code>PYTHONPATH="PYTHONPATH:$PWD" python -m pytest tests</code>. This will fix the python path so the imports work correctly in the tests.</p>
</div>
<h2 id="dag">DAG</h2>
<p>Now that we have all the necessary functions we just need to write the DAG.</p>
<h3 id="overview">Overview</h3>
<p>To get an intuitive understanding of what DAG definitions do we will first show you how we would write the code in a regular python script that we want to run from the console. After that we will write the real Typhoon DAG code so the reader can compare.</p>
<div class="admonition warning">
<p class="admonition-title">Not real code</p>
<p>This is just an intuitive understanding of what the DAG compiles to. It's a useful model to have even though it's not entirely accurate as we will see later.</p>
<p>Take a moment to understand this code, it will help you as a reference once we introduce the DAG code.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">DIRECTORY</span> <span class="o">=</span> <span class="s1">&#39;/tmp/typhoon/landing/&#39;</span>
<span class="n">SQLITE_DB</span> <span class="o">=</span> <span class="s1">&#39;/tmp/typhoon/tutorial.db&#39;</span>
<span class="n">INSERT_QUERY</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO TABLE typhoon_tutorial VALUES (?, ?, ?)&#39;</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">get_files_in_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">DIRECTORY</span><span class="p">)</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">words_in_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()]</span>
    <span class="n">execute_on_sqlite</span><span class="p">(</span><span class="n">sqlite_db</span><span class="o">=</span><span class="n">SQLITE_DB</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">INSERT_QUERY</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
</code></pre></div>
<h3 id="graph-representation">Graph representation</h3>
<p>We can visualize these tasks in a Direct Acyclig Graph (DAG). This is how we could define the DAG:</p>
<div class="mermaid">graph LR
    subgraph DAG
    ls -- e1 --&gt; count_words
    count_words -- e2 --&gt; write_to_db
    end</div>
<p>Typhoon uses graph terminology in DAGs, defining tasks in terms of <strong>nodes</strong> and <strong>edges</strong>.</p>
<p>However, at run-time ls will yield a batch for each file it finds. Assuming if finds <code>a.txt</code>, <code>b.txt</code> and <code>c.txt</code> then it will yield three batches and there will be a count_words task for each. The count words node just returns one value/batch so it won't branch any further. We can visualize the run-time shape of this DAG as the following:</p>
<div class="mermaid">graph TB
    subgraph DAG
    ls-- a.txt --&gt;count_words
    ls-- b.txt --&gt;count_words2
    ls-- c.txt --&gt;count_words3
    subgraph Branch one
    count_words -- a.txt, 12 --&gt; write_to_db
    end
    subgraph Branch two
    count_words2 -- b.txt, 9 --&gt; write_to_db2
    end
    subgraph Branch three
    count_words3 -- c.txt, 17 --&gt; write_to_db3
    end
    end</div>
<h3 id="dag-code">DAG Code</h3>
<p>Now that we have an idea of what we want to do let's write the real DAG code that does the same.</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tutorial</span>
<span class="nt">schedule_interval</span><span class="p">:</span> <span class="s">&quot;@hourly&quot;</span>

<span class="nt">nodes</span><span class="p">:</span>
  <span class="nt">ls</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.get_files_in_directory</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/typhoon/landing/</span> 

  <span class="nt">count_words</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.words_in_file</span>

  <span class="nt">write_to_db</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.execute_on_sqlite</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">sqlite_db</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/typhoon/tutorial.db</span>
      <span class="nt">insert_query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INSERT INTO TABLE typhoon_tutorial VALUES (?, ?, ?)</span>

<span class="nt">edges</span><span class="p">:</span>
  <span class="nt">e1</span><span class="p">:</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ls</span>
    <span class="nt">adapter</span><span class="p">:</span>
      <span class="nt">file_path =&gt; APPLY</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
    <span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">count_words</span>

  <span class="nt">e2</span><span class="p">:</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">count_words</span>
    <span class="nt">adapter</span><span class="p">:</span>
      <span class="nt">parameters =&gt; APPLY</span><span class="p">:</span> <span class="s">&quot;[$BATCH[0],</span><span class="nv"> </span><span class="s">$BATCH[1],</span><span class="nv"> </span><span class="s">$DAG_CONTEXT.execution_date.isoformat()]&quot;</span>
    <span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write_to_db</span>
</code></pre></div>
<p>Save this code in <code>dags/tutorial.yml</code>.</p>
<div class="admonition info">
<p class="admonition-title">Config Vs Adapter</p>
<p>Notice how in config we are passing the static parameters, while in the adapter we are constructing the dynamic parameters from the source node's batch.</p>
<p>Think of config as parameters that are static configuration, while adapter adapts the output of the source node to the dynamic input parameter of the destination node.</p>
</div>
<h3 id="testing-the-edges">Testing the edges</h3>
<p>It can seem like the downside to having a YAML file is that code in the adapters can't be unit tested like functions can. To fix that Typhoon lets you test edges on the CLI by providing an input batch. Our DAG does not have much transformation logic, but it does have some in edge <code>e2</code>which we can test with:</p>
<div class="highlight"><pre><span></span><code>typhoon dag edge <span class="nb">test</span> --dag-name tutorial --edge-name e2 --input <span class="s2">&quot;[&#39;a.txt&#39;, 3]&quot;</span> --eval
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Eval</p>
<p>Without the <code>--eval</code> flag our input batch would be a string. We need it to evaluate that string as python code.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Testing different execution dates</p>
<p>Since the result uses the execution date we can pass it as a parameter to test with
<code>--execution-date '2019-01-02'</code>. It accepts dates with any of the following formats <code>%Y-%m-%d</code>, <code>%Y-%m-%dT%H:%M:%S</code> or <code>%Y-%m-%d %H:%M:%S</code>. Since we didn't use any in the previous example it used the current time.</p>
</div>
<h3 id="running-the-dag">Running the DAG</h3>
<h4 id="creating-the-sqlite-table">Creating the SQLite table</h4>
<p>In order for the DAG to work our database needs to have the <code>typhoon_tutorial</code> table defined.</p>
<div class="highlight"><pre><span></span><code>&gt; sqlite3 /tmp/typhoon/tutorial.db
SQLite version 3.30.1 2019-10-10 20:19:45
Enter &quot;.help&quot; for usage hints.
sqlite&gt; CREATE TABLE typhoon_tutorial (file_name TEXT, num_words INT, ts TEXT);
</code></pre></div>
<h4 id="dag-run">DAG run</h4>
<p>We can now run the DAG to check that it works as expected. </p>
<div class="highlight"><pre><span></span><code>typhoon dag run --dag-name tutorial
</code></pre></div>
<p>Result:
<div class="highlight"><pre><span></span><code>Running tutorial from local build...
Cleaning out directory...
Build all DAGs...
Writing file to /Users/biellls/Desktop/typhoon/hello_world/out/template.yml
Writing file to /Users/biellls/Desktop/typhoon/hello_world/out/tutorial/requirements.txt
Typhoon package is in editable mode. Copying to lambda package...
Setting up user defined code as symlink for debugging...
Finished building DAGs
</code></pre></div></p>
<h4 id="checking-results">Checking results</h4>
<p>Lets read the table to make sure we inserted the data correctly:</p>
<div class="highlight"><pre><span></span><code>&gt; sqlite3 /tmp/typhoon/tutorial.db
SQLite version 3.30.1 2019-10-10 20:19:45
Enter &quot;.help&quot; for usage hints.
sqlite&gt; .headers on
sqlite&gt; .mode column
sqlite&gt; select * from typhoon_tutorial;
file_name                   num_words   ts
--------------------------  ----------  --------------------------
/tmp/typhoon/landing/a.txt  5           2020-01-17T18:36:39.489866
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections"], "search": "../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c44cc438.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>