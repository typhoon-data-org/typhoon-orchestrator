
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.10">
    
    
      
        <title>Improving our DAG - Typhoon Orchestrator</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.1fe995fd.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
    
      
  



  
  



  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154972398-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL(".",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#improving-our-dag" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Typhoon Orchestrator" class="md-header__button md-logo" aria-label="Typhoon Orchestrator" data-md-component="logo">
      
  <img src="img/typhoon_solo_inverted2.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Typhoon Orchestrator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Improving our DAG
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/typhoon-data-org/typhoon-orchestrator/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="index.html" class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="getting-started/installation.html" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="examples/hello-world.html" class="md-tabs__link">
        Example Walkthroughs
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="usage/dag-context.html" class="md-tabs__link">
        Usage
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="contributing.md" class="md-tabs__link">
      Contributing
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Typhoon Orchestrator" class="md-nav__button md-logo" aria-label="Typhoon Orchestrator" data-md-component="logo">
      
  <img src="img/typhoon_solo_inverted2.png" alt="logo">

    </a>
    Typhoon Orchestrator
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/typhoon-data-org/typhoon-orchestrator/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Getting Started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/installation.html" class="md-nav__link">
        Installation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="examples/hello-world.html" class="md-nav__link">
        Hello World
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/typhoon-cli.html" class="md-nav__link">
        Typhoon Cli
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/creating-a-dag.html" class="md-nav__link">
        Creating your DAG
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/connections.html" class="md-nav__link">
        Adding connections
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/deployment.html" class="md-nav__link">
        Deployment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/using-components.html" class="md-nav__link">
        Using Components
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/using-component-ui.html" class="md-nav__link">
        UI configurator
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="getting-started/creating-hooks.html" class="md-nav__link">
        New Hooks (connections)
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Example Walkthroughs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Example Walkthroughs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Example Walkthroughs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="examples/hello-world.html" class="md-nav__link">
        Hello World
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="examples/mysql-to-snowflake.html" class="md-nav__link">
        MySql to Snowflake
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="examples/pandas-examples.html" class="md-nav__link">
        Pandas automation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Usage
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/dag-context.html" class="md-nav__link">
        Dag Context
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/py-multistep.html" class="md-nav__link">
        !Py & !Multistep
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/task-flow-control.html" class="md-nav__link">
        Task flow control
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/task-testing.html" class="md-nav__link">
        Task testing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/functions.html" class="md-nav__link">
        Functions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/transformations.html" class="md-nav__link">
        Transformations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/components.html" class="md-nav__link">
        Components
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/hooks.html" class="md-nav__link">
        Hooks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="usage/templates.html" class="md-nav__link">
        Variables & Templates
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="contributing.md" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    Variables
  </a>
  
    <nav class="md-nav" aria-label="Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql-as-variable" class="md-nav__link">
    SQL as variable
  </a>
  
    <nav class="md-nav" aria-label="SQL as variable">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-the-variable" class="md-nav__link">
    Adding the variable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connections" class="md-nav__link">
    Connections
  </a>
  
    <nav class="md-nav" aria-label="Connections">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filesystem-hook" class="md-nav__link">
    FileSystem Hook
  </a>
  
    <nav class="md-nav" aria-label="FileSystem Hook">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-the-ls-node" class="md-nav__link">
    Changing the ls node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-the-hook" class="md-nav__link">
    Adding the hook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-the-files" class="md-nav__link">
    Reading the files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-the-count_words-node-and-function" class="md-nav__link">
    Changing the count_words node and function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#db-api-hook" class="md-nav__link">
    DB-API Hook
  </a>
  
    <nav class="md-nav" aria-label="DB-API Hook">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-the-write_to_db-node" class="md-nav__link">
    Changing the write_to_db node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-the-hook_1" class="md-nav__link">
    Adding the hook
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edges-putting-it-all-together" class="md-nav__link">
    Edges: putting it all together
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/typhoon-data-org/typhoon-orchestrator/edit/master/docs/dag-development-improving.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="improving-our-dag">Improving our DAG</h1>
<p>In the previous section we created a DAG that reads from a local directory and writes to a SQLite file. We will now improve on that DAG by introducing new concepts that will help us make it more flexible and testable.</p>
<h2 id="variables">Variables</h2>
<p>Variables let us define a value outside our DAG. In general it is a good idea not to hard code magic values into our code, and DAGs in Typhoon are no exception. This makes it easier to change or tune the value without requiring us to re-deploy our DAG.</p>
<div class="admonition info">
<p class="admonition-title">Similar to Airflow's variables</p>
<p>If you're familiar with Airflow you'll notice that it's the same concept as Airflow variables. As much as possible Typhoon tries to depart from tried and tested solutions only when it makes . Variables and connections are something that for the most part just works in Airflow, so we saw no reason to change it adding more cognitive burden on developers.</p>
<p>With that said it's worth pointing out the differences. In Typhoon variables have types associated with them. If a variable is of type JSON or YAML it will get loaded into a python object. If you need it to be loaded as a string prefer to choose the TEXT type.</p>
</div>
<h3 id="sql-as-variable">SQL as variable</h3>
<p>Let's move our insert statement into a variable so we can change it in the future if we need to. We'll change the line</p>
<div class="highlight"><pre><span></span><code><span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INSERT INTO typhoon_tutorial VALUES (?, ?, ?)</span>
</code></pre></div>
<p>for:
<div class="highlight"><pre><span></span><code><span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$VARIABLE.tutorial_insert_query</span>
</code></pre></div></p>
<p>We named our variable <code>insert_query</code> but we could have given it any name.</p>
<div class="admonition tip">
<p class="admonition-title">Typhoon status</p>
<p>If we run <code>typhoon status</code> now we will see the following warning:</p>
<div class="highlight"><pre><span></span><code>â€¢ Found variables in DAGs that are not defined in the metadata database
   - Variable tutorial_insert_query is not set. Try typhoon variable add --var-id tutorial_insert_query --var-type VAR_TYPE --contents VALUE None
</code></pre></div>
<p>It's useful to run <code>typhoon status</code> often as it will warn us about problems on our project. Lets define the variable now as suggested:</p>
</div>
<h4 id="adding-the-variable">Adding the variable</h4>
<p>We will also turn the variable into a Jinja template which we will render later.</p>
<div class="highlight"><pre><span></span><code>typhoon variable add --var-id tutorial_insert_query --var-type jinja --contents <span class="s2">&quot;INSERT INTO TABLE typhoon_tutorial VALUES ({{ file_name }}, {{ num_words }}, {{ ts }})&quot;</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Adding variables from STDIN</p>
<p>We can add variables from STDIN by leaving out the <code>--contents</code> argument. This will prompt us to give the value for the variable. We can also pipe the value UNIX style. Eg: <code>cat query_file.sql | typhoon variable add --var-id tutorial_insert_query --var-type jinja</code> or <code>typhoon variable add --var-id tutorial_insert_query2 --var-type string &lt; query_file.sql</code></p>
</div>
<p>We can now run <code>typhoon status</code> again to see there is no issue, and check our newly created variable  with:</p>
<div class="highlight"><pre><span></span><code>typhoon variable ls -l
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Web UI DAG Editor</p>
<p>The web UI has an experimental DAG editor with intelligent code completion for things like variable and connection names, as well as functions, transformations and node names. However it's sometimes a little behind the CLI and can have some bugs caused by syntax checking. It will be re-written at some point in the future, but in the mean time check it out with <code>typhoon webserver</code>. It's really useful when it works correctly.</p>
</div>
<h2 id="connections">Connections</h2>
<p>In our functions we hardcoded the logic to read from the filesystem and to write to SQLite. This is not ideal for a few reasons:</p>
<ul>
<li>Limited re-usability: Overly specific functions means we are unlikely to find them useful in other DAGs.</li>
<li>Limited flexibility: If the logic stays the same but the data source changes (eg: Postgres instead of SQLite) we need to modify the function.</li>
<li>Security: Hard-coding connection details in functions is never a good idea. Passing them as parameters in DAGs is not much better as you probably want to version control your DAGs.</li>
</ul>
<p>To solve this Typhoon provides Connections which let you define a type (eg: SQLite) and connection parameters. Connections are stored in the database and are used to instantiate hooks. The connection type determines which hook class needs to be instantiated.</p>
<p>Lets now change both the source and destination to use connections.</p>
<div class="admonition info">
<p class="admonition-title">Similarities with Airflow</p>
<p>Connections in Typhoon are also very similar to Airflow's connections, down to naming of their parameters and the inclusion of an extra field for parameters that don't fit in the default ones. We depart from Airflow in some ways however:</p>
<ul>
<li>In contrast to Airflow it <strong>lets the user define new connection types that are first class</strong> (ie: you get code completion for them in the CLI and you can select them in the UI).</li>
<li>It attempts to group similar connections in interfaces/protocols so that they can be swapped for one another, simplifying testing or data source changes. Airflow does this somewhat, for example with DbApiHook, but we take this concept a lot further by grouping other similar data sources such as filesystems (Local Storage, FTP, SFTP, S3 etc can all be used interchangeably). Of course you can always access the underlying connection if you need specific functionality that is not easily re-usable.</li>
</ul>
</div>
<h3 id="filesystem-hook">FileSystem Hook</h3>
<p>To read from the directory we will use a <code>FileSystemHook</code>. Specifically a <code>LocalStorageHook</code> though as we'll see this can be changed later. We'll also use a pre-defined Typhoon function called <code>list_directory</code> to list files in the directory and another one called <code>read_data</code> to read data from these files.</p>
<h4 id="changing-the-ls-node">Changing the ls node</h4>
<p>We need to change the line</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">ls</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.get_files_in_directory</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/typhoon/landing/</span>
</code></pre></div>
<p>to:
<div class="highlight"><pre><span></span><code>  <span class="nt">ls</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.list_directory</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.tutorial_fs</span>
      <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">landing</span>
</code></pre></div></p>
<p>Notice how we no longer define the full path in the DAG. FileSystem hooks have a base path that gets prepended to it (eg: In the S3 hook that's the bucket, in an FTP hook you might want a different base directory for testing and another for production etc.).</p>
<h4 id="adding-the-hook">Adding the hook</h4>
<p>We will add the hook to our <code>connections.yml</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="nt">tutorial_fs</span><span class="p">:</span>
  <span class="nt">local</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local_storage</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">base_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/typhoon/</span>
</code></pre></div>
<p>Then add it to our metadata database:</p>
<div class="highlight"><pre><span></span><code>typhoon connection add --conn-id tutorial_fs --conn-env <span class="nb">local</span>
</code></pre></div>
<h4 id="reading-the-files">Reading the files</h4>
<p>We will add an additional node to read the file contents using another predefined Typhoon function:</p>
<div class="highlight"><pre><span></span><code><span class="nt">read_file</span><span class="p">:</span>
  <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.read_data</span>
  <span class="nt">config</span><span class="p">:</span>
    <span class="nt">hook</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$hook.tutorial_fs</span>
</code></pre></div>
<h3 id="changing-the-count_words-node-and-function">Changing the count_words node and function</h3>
<p>We will change our function to receive a text and just count the words, removing the file reading logic from it. It is generally a good idea for a function to do one and only one thing. We will also take a dict of metadata so we can keep track of where the text came from.</p>
<div class="highlight"><pre><span></span><code><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">words_in_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">T</span><span class="p">]:</span>
    <span class="n">num_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_words</span><span class="p">,</span> <span class="n">metadata</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">count_words</span><span class="p">:</span>
  <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.words_in_text</span>
</code></pre></div>
<h3 id="db-api-hook">DB-API Hook</h3>
<p>We will continue making our DAG more generic by using the Typhoon function execute_query, which takes a <code>DbApiHook</code>, which can be any hook supporting the <a href="https://www.python.org/dev/peps/pep-0249/">DB-API interface</a>. Almost every database library in Python supports it, so we will be able to use them interchangeably (if the SQL query is valid in both databases).</p>
<h4 id="changing-the-write_to_db-node">Changing the write_to_db node</h4>
<p>We will change</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">write_to_db</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.execute_on_sqlite</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">sqlite_db</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/typhoon/tutorial.db</span>
      <span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$VARIABLE.tutorial_insert_query</span>
</code></pre></div>
<p>to:</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">write_to_db</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.relational.execute_query</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.tutorial_db</span>
      <span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$VARIABLE.tutorial_insert_query</span>
</code></pre></div>
<h4 id="adding-the-hook_1">Adding the hook</h4>
<p>First we define the connection details in the <code>connections.yml</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="nt">tutorial_db</span><span class="p">:</span>
  <span class="nt">dev</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqlite</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">database</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/typhoon/tutorial.db</span>
</code></pre></div>
<p>Then we add the connection with the CLI:</p>
<div class="highlight"><pre><span></span><code>typhoon connection add --conn-id tutorial_db --conn-env <span class="nb">local</span>
</code></pre></div>
<h3 id="edges-putting-it-all-together">Edges: putting it all together</h3>
<p>Finally to make all of this come together we need toWe need to change the edges. The final DAG will be:</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tutorial</span>
<span class="nt">schedule_interval</span><span class="p">:</span> <span class="s">&quot;@hourly&quot;</span>

<span class="nt">nodes</span><span class="p">:</span>
  <span class="nt">ls</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.list_directory</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.tutorial_fs</span>
      <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">landing</span>

  <span class="nt">read_file</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.read_data</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$hook.tutorial_fs</span>

  <span class="nt">count_words</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.tutorial.words_in_text</span>

  <span class="nt">write_to_db</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.relational.execute_query</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.tutorial_db</span>
      <span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$VARIABLE.tutorial_insert_query</span>

<span class="nt">edges</span><span class="p">:</span>
  <span class="nt">e1</span><span class="p">:</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ls</span>
    <span class="nt">adapter</span><span class="p">:</span>
      <span class="nt">file_path =&gt; APPLY</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
    <span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">count_words</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">file_path =&gt; APPLY</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$ADAPTER.file_path</span>

  <span class="nt">e2</span><span class="p">:</span>
    <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">count_words</span>
    <span class="nt">adapter</span><span class="p">:</span>
      <span class="nt">parameters =&gt; APPLY</span><span class="p">:</span> <span class="s">&quot;[$BATCH[0],</span><span class="nv"> </span><span class="s">$BATCH_METADATA.file_path,</span><span class="nv"> </span><span class="s">$DAG_CONTEXT.execution_date.isoformat()]&quot;</span>
    <span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write_to_db</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>