
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.8">
    
    
      
        <title>Favorite Author Extended - TYPHOON</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.644de097.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="typhoon" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#favorite-author-extended-version" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TYPHOON" class="md-header__button md-logo" aria-label="TYPHOON" data-md-component="logo">
      
  <img src="../../img/typhoon_flat_icon_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TYPHOON
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Favorite Author Extended
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/typhoon-data-org/typhoon-orchestrator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/installation/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../hello-world/" class="md-tabs__link md-tabs__link--active">
        Example Walkthroughs
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../usage/dag-context/" class="md-tabs__link">
        Usage
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TYPHOON" class="md-nav__button md-logo" aria-label="TYPHOON" data-md-component="logo">
      
  <img src="../../img/typhoon_flat_icon_white.png" alt="logo">

    </a>
    TYPHOON
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/typhoon-data-org/typhoon-orchestrator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hello-world/" class="md-nav__link">
        Hello World
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/typhoon-cli/" class="md-nav__link">
        Typhoon Cli
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/creating-a-dag/" class="md-nav__link">
        Creating your DAG
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/connections/" class="md-nav__link">
        Adding connections
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/deployment/" class="md-nav__link">
        Deployment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/using-components/" class="md-nav__link">
        Using Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/using-component-ui/" class="md-nav__link">
        Component UI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/creating-hooks/" class="md-nav__link">
        New Hooks (connections)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/typhoon-shell/" class="md-nav__link">
        Typhoon Shell
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Example Walkthroughs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Example Walkthroughs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Example Walkthroughs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hello-world/" class="md-nav__link">
        Hello World
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql-to-snowflake/" class="md-nav__link">
        MySql to Snowflake
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pandas-examples/" class="md-nav__link">
        Pandas automation
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Favorite Author Extended
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Favorite Author Extended
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#custom-functions-to-call-apis" class="md-nav__link">
    Custom functions to call APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#splitting-list-of-json-into-batches-in-a-custom-function" class="md-nav__link">
    Splitting list of JSON into batches in a custom function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#if-then-logic" class="md-nav__link">
    If Then logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtering-json-with-jmespath" class="md-nav__link">
    Filtering JSON with JMESPath
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/dag-context/" class="md-nav__link">
        Dag Context
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/py-multistep/" class="md-nav__link">
        !Py & !Multistep
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/task-flow-control/" class="md-nav__link">
        Task flow control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/task-testing/" class="md-nav__link">
        Task testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/functions/" class="md-nav__link">
        Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/transformations/" class="md-nav__link">
        Transformations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/components/" class="md-nav__link">
        Components
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/hooks/" class="md-nav__link">
        Hooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/templates/" class="md-nav__link">
        Variables & Templates
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#custom-functions-to-call-apis" class="md-nav__link">
    Custom functions to call APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#splitting-list-of-json-into-batches-in-a-custom-function" class="md-nav__link">
    Splitting list of JSON into batches in a custom function
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#if-then-logic" class="md-nav__link">
    If Then logic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtering-json-with-jmespath" class="md-nav__link">
    Filtering JSON with JMESPath
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="favorite-author-extended-version">Favorite Author - extended version</h1>
<p>The front page example 'favorite author' can be extended to illustrate some more advanced concepts:</p>
<ul>
<li>Splitting list into batches for individual processing</li>
<li>Custom Functions (e.g. API calls)</li>
<li>Custom Transformations</li>
<li>If Then logic</li>
<li>Filtering <a href="https://jmespath.org/">JMESPath</a></li>
<li>2 apis, in chain</li>
</ul>
<p>We will not go line by line but to call out several specific points.</p>
<p>Firstly here is the DAG graph (Airflow compiled) which explains the structure well:</p>
<p>Here is the YAML it was compiled from:</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">favorite_authors_extended_full</span>
<span class="nt">schedule_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rate(1 day)</span>

<span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">&gt;</span>
  <span class="no">A more complex DAG:</span>
    <span class="no">- Splitting list into batches for individual processing</span>
    <span class="no">- Custom Functions (e.g. API calls)</span>
    <span class="no">- Custom Transformations</span>
    <span class="no">- If Then logic</span>
    <span class="no">- Filtering JMESPath (JSON filtering / search)</span>
    <span class="no">- 2 apis, in chain</span>


<span class="nt">tasks</span><span class="p">:</span>
  <span class="nt">choose_favorites</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.flow_control.branch</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">branches</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">J. K. Rowling</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">George R. R. Martin</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">James Clavell</span>

  <span class="nt">get_author</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">choose_favorites</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.open_library_api.get_author</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">requested_author</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
      <span class="nt">split_list_into_batches</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>


  <span class="nt">is_fuzzy_author</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">get_author</span>
    <span class="nt">component</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.ifthen</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">condition</span><span class="p">:</span> <span class="kt">!Py</span> <span class="p p-Indicator">|</span>
        <span class="no">lambda x: transformations.author_cleaning.is_similar_name(</span>
          <span class="no">x[&#39;name&#39;], </span>
          <span class="no">x[&#39;requested_author&#39;],</span>
          <span class="no">96</span>
        <span class="no">)</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>


  <span class="nt">print_match</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.then</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.debug.echo</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;ACCEPTED --  {$BATCH[&#39;name&#39;]}.&quot;</span>

  <span class="nt">print_not_matched</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.otherwise</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.debug.echo</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;DISCARDED -- {$BATCH[&#39;name&#39;]} is not similar enough.&quot;</span>


  <span class="nt">select_keys_valid_author_json</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.then</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.json.search</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">expression</span><span class="p">:</span> <span class="s">&quot;{key:key,</span><span class="nv"> </span><span class="s">name:name,</span><span class="nv"> </span><span class="s">birth_date:</span><span class="nv"> </span><span class="s">birth_date,</span><span class="nv"> </span><span class="s">work_count:</span><span class="nv"> </span><span class="s">work_count,</span><span class="nv"> </span><span class="s">top_work:</span><span class="nv"> </span><span class="s">top_work,</span><span class="nv"> </span><span class="s">requested_author:requested_author</span><span class="nv"> </span><span class="s">}&quot;</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>

  <span class="nt">write_valid_author_json</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">select_keys_valid_author_json</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.write_data</span>    
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Hook</span> <span class="l l-Scalar l-Scalar-Plain">data_lake</span>
      <span class="nt">data</span><span class="p">:</span>  <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">transformations.author_cleaning.json_dumps($BATCH)</span>
      <span class="nt">path</span><span class="p">:</span> <span class="kt">!MultiStep</span> 
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH[&#39;key&#39;]</span>
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&#39;/valid_authors/{$1}.json&#39;</span>
      <span class="nt">create_intermediate_dirs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>


  <span class="nt">write_error_path_author_json</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.otherwise</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.write_data</span>    
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Hook</span> <span class="l l-Scalar l-Scalar-Plain">data_lake</span>
      <span class="nt">data</span><span class="p">:</span>  <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">transformations.author_cleaning.json_dumps($BATCH)</span>
      <span class="nt">path</span><span class="p">:</span> <span class="kt">!MultiStep</span> 
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH[&#39;key&#39;]</span>
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&#39;/error_authors/{$1}.json&#39;</span>
      <span class="nt">create_intermediate_dirs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

  <span class="nt">get_works</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">select_keys_valid_author_json</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.open_library_api.get_works</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">limit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
      <span class="nt">author_key</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH[&#39;key&#39;]</span>

  <span class="nt">write_works_json</span><span class="p">:</span>
      <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">get_works</span>
      <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.write_data</span>
      <span class="nt">args</span><span class="p">:</span>
        <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Hook</span> <span class="l l-Scalar l-Scalar-Plain">data_lake</span>
        <span class="nt">data</span><span class="p">:</span>  <span class="kt">!MultiStep</span>
          <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH[&#39;entries&#39;]</span>
          <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.data.json_array_to_json_records($1)</span>
        <span class="nt">path</span><span class="p">:</span> <span class="kt">!MultiStep</span> 
          <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH[&#39;links&#39;][&#39;author&#39;].replace(&#39;/authors/&#39;, &#39;&#39;)</span>
          <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&#39;/works/{$1}.json&#39;</span>
        <span class="nt">create_intermediate_dirs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</code></pre></div>
<h2 id="custom-functions-to-call-apis">Custom functions to call APIs</h2>
<p>These two functions are used to call the Open Library APIs. This is the only complex piece of python code.  </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;https://openlibrary.org/search/authors.json&#39;</span>
<span class="n">ENDPOINT_WORKS</span> <span class="o">=</span> <span class="s1">&#39;https://openlibrary.org/authors&#39;</span>


<span class="k">def</span> <span class="nf">get_author</span><span class="p">(</span>
        <span class="n">requested_author</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">split_list_into_batches</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">requested_author</span>    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calling endpoint Get Authors&#39;</span>  <span class="o">+</span> <span class="n">ENDPOINT</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>     
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;docs&#39;</span><span class="p">]:</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;requested_author&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">requested_author</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">split_list_into_batches</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">docs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">docs</span>


<span class="k">def</span> <span class="nf">get_works</span><span class="p">(</span>
        <span class="n">author_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>    
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">limit</span>
    <span class="p">}</span>
    <span class="n">full_endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ENDPOINT_WORKS</span><span class="si">}</span><span class="s1">/&#39;</span><span class="o">+</span> <span class="n">author_key</span> <span class="o">+</span> <span class="s1">&#39;/works.json&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calling endpoint </span><span class="si">{</span><span class="n">full_endpoint</span><span class="si">}</span><span class="s1"> for author key &#39;</span> <span class="o">+</span> <span class="n">author_key</span><span class="p">)</span>    
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">full_endpoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>
<p>You see we call this in the YAML with the simple:</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">get_author</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">choose_favorites</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functions.open_library_api.get_author</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">requested_author</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
      <span class="nt">split_list_into_batches</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<h2 id="splitting-list-of-json-into-batches-in-a-custom-function">Splitting list of JSON into batches in a custom function</h2>
<p>In this case the API we use, Open Library, returns a list of many JSON objects.</p>
<p>We are requesting for example "J. K. Rowling" and the API returns fuzzy matches or related authors. </p>
<p><div class="highlight"><pre><span></span><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="err">J.</span> <span class="err">K.</span> <span class="err">Rowli</span><span class="kc">n</span><span class="err">g</span><span class="p">,</span>
    <span class="err">...</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="err">J</span> <span class="err">N</span> <span class="err">Rowli</span><span class="kc">n</span><span class="err">g</span><span class="p">,</span>
    <span class="err">...</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="err">J.</span> <span class="err">J.</span> <span class="err">Rowli</span><span class="kc">n</span><span class="err">gs</span><span class="p">,</span>
    <span class="err">...</span>
  <span class="p">}</span>
</code></pre></div>
We want to apply a lambda function against each of these so we must process each row individually. To do this we split the list into individual batches by using 'yield from' in the api function:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_author</span><span class="p">(</span>
        <span class="n">requested_author</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">split_list_into_batches</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>

    <span class="o">...</span>

    <span class="k">if</span> <span class="n">split_list_into_batches</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">docs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">docs</span>
</code></pre></div>
<p>This allows us to use the arg <code>split_list_into_batches: true</code> in the YAML. This will then return each of the items in the list as a separate <code>$BATCH</code>.</p>
<h2 id="if-then-logic">If Then logic</h2>
<p>This DAG uses some If Then logic to handle cleaning and validation. This is not a good example of cleaning but a trivial one to show some possible structure. </p>
<p>We are using a transformation function to check if the name requested was similar and if not, to discard the row. </p>
<p>In this case the If Then logic is based on the outcome of the is_similar_name transformation python. We use the outcome twice: once for a set of debug print statements and then also to pass data to downstream steps. </p>
<div class="highlight"><pre><span></span><code>  <span class="nt">is_fuzzy_author</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">get_author</span>
    <span class="nt">component</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.ifthen</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">condition</span><span class="p">:</span> <span class="kt">!Py</span> <span class="p p-Indicator">|</span>
        <span class="no">lambda x: transformations.author_cleaning.is_similar_name(</span>
          <span class="no">x[&#39;name&#39;], </span>
          <span class="no">x[&#39;requested_author&#39;],</span>
          <span class="no">96</span>
        <span class="no">)</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>


  <span class="nt">print_match</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.then</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.debug.echo</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;ACCEPTED --  {$BATCH[&#39;name&#39;]}.&quot;</span>

  <span class="nt">print_not_matched</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.otherwise</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.debug.echo</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;DISCARDED -- {$BATCH[&#39;name&#39;]} is not similar enough.&quot;</span>
</code></pre></div>
<h2 id="filtering-json-with-jmespath">Filtering JSON with JMESPath</h2>
<p>A great library that we have included is JMESPath which you can use to reduce and transform JSON data easily.</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">select_keys_valid_author_json</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">is_fuzzy_author.otherwise</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.json.search</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">expression</span><span class="p">:</span> <span class="s">&quot;{key:key,</span><span class="nv"> </span><span class="s">name:name,</span><span class="nv"> </span><span class="s">birth_date:</span><span class="nv"> </span><span class="s">birth_date,</span><span class="nv"> </span><span class="s">work_count:</span><span class="nv"> </span><span class="s">work_count,</span><span class="nv"> </span><span class="s">top_work:</span><span class="nv"> </span><span class="s">top_work,</span><span class="nv"> </span><span class="s">requested_author:requested_author</span><span class="nv"> </span><span class="s">}&quot;</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
</code></pre></div>
<p>This expression above reduces the JSON to only the selected fields. You can explore this more on <a href="https://jmespath.org/">JMESPath</a>.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../pandas-examples/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Pandas automation" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Pandas automation
            </div>
          </div>
        </a>
      
      
        
        <a href="../../usage/dag-context/" class="md-footer__link md-footer__link--next" aria-label="Next: Dag Context" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Dag Context
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections"], "search": "../../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c44cc438.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>