
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.10">
    
    
      
        <title>MySql to Snowflake - TYPHOON</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1fe995fd.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
    
      
  



  
  



  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154972398-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="typhoon" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mysql-to-snowflake" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="TYPHOON" class="md-header__button md-logo" aria-label="TYPHOON" data-md-component="logo">
      
  <img src="../img/typhoon_flat_icon_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TYPHOON
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MySql to Snowflake
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/typhoon-data-org/typhoon-orchestrator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../index.html" class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../getting-started/installation.html" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="hello-world.html" class="md-tabs__link md-tabs__link--active">
        Example Walkthroughs
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../usage/dag-context.html" class="md-tabs__link">
        Usage
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="TYPHOON" class="md-nav__button md-logo" aria-label="TYPHOON" data-md-component="logo">
      
  <img src="../img/typhoon_flat_icon_white.png" alt="logo">

    </a>
    TYPHOON
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/typhoon-data-org/typhoon-orchestrator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    typhoon-orchestrator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Getting Started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation.html" class="md-nav__link">
        Installation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="hello-world.html" class="md-nav__link">
        Hello World
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/typhoon-cli.html" class="md-nav__link">
        Typhoon Cli
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/creating-a-dag.html" class="md-nav__link">
        Creating your DAG
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/connections.html" class="md-nav__link">
        Adding connections
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/deployment.html" class="md-nav__link">
        Deployment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/using-components.html" class="md-nav__link">
        Using Components
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/using-component-ui.html" class="md-nav__link">
        Component UI
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/creating-hooks.html" class="md-nav__link">
        New Hooks (connections)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/typhoon-shell.html" class="md-nav__link">
        Typhoon Shell
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Example Walkthroughs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Example Walkthroughs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Example Walkthroughs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="hello-world.html" class="md-nav__link">
        Hello World
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          MySql to Snowflake
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="mysql-to-snowflake.html" class="md-nav__link md-nav__link--active">
        MySql to Snowflake
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#list_tables" class="md-nav__link">
    List_tables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-from-mysql" class="md-nav__link">
    Extracting from MySQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-each-table-to-s3-in-json" class="md-nav__link">
    Write each table to S3 in JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-reating-a-function-to-output-to-json" class="md-nav__link">
    (Optional) reating a function to output to JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switching-to-s3" class="md-nav__link">
    Switching to S3
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy-data-to-snowflake" class="md-nav__link">
    Copy data to Snowflake
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#helper-assets" class="md-nav__link">
    Helper Assets
  </a>
  
    <nav class="md-nav" aria-label="Helper Assets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#yaml-connections" class="md-nav__link">
    YAML connections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mock-data" class="md-nav__link">
    Mock data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="pandas-examples.html" class="md-nav__link">
        Pandas automation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="favorite_author_extended.html" class="md-nav__link">
        Favorite Author Extended
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Usage
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/dag-context.html" class="md-nav__link">
        Dag Context
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/py-multistep.html" class="md-nav__link">
        !Py & !Multistep
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/task-flow-control.html" class="md-nav__link">
        Task flow control
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/task-testing.html" class="md-nav__link">
        Task testing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/functions.html" class="md-nav__link">
        Functions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/transformations.html" class="md-nav__link">
        Transformations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/components.html" class="md-nav__link">
        Components
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/hooks.html" class="md-nav__link">
        Hooks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../usage/templates.html" class="md-nav__link">
        Variables & Templates
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#list_tables" class="md-nav__link">
    List_tables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-from-mysql" class="md-nav__link">
    Extracting from MySQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-each-table-to-s3-in-json" class="md-nav__link">
    Write each table to S3 in JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-reating-a-function-to-output-to-json" class="md-nav__link">
    (Optional) reating a function to output to JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#switching-to-s3" class="md-nav__link">
    Switching to S3
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy-data-to-snowflake" class="md-nav__link">
    Copy data to Snowflake
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#helper-assets" class="md-nav__link">
    Helper Assets
  </a>
  
    <nav class="md-nav" aria-label="Helper Assets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#yaml-connections" class="md-nav__link">
    YAML connections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mock-data" class="md-nav__link">
    Mock data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="mysql-to-snowflake">MySql to Snowflake</h1>
<p>Now we know the basics, lets make something more useful.</p>
<p>For brevity the full connections YAML is included below for you to copy and replace your keys. However, we will be quite thorough to make sure each step is clear.</p>
<p>In this example, I need to take two tables ['clients', 'sales'] from our production MySql (replace with your favourite RDBMS) to Snowflake (replace with your favourite cloud DWH). Sample data for MySQL is included at the bottom.</p>
<p>We are going to load our data into a VARIANT field in Snowflake as this pattern is <em>very fault tolerant</em>.</p>
<p><strong>Overview of what we want to do:</strong></p>
<ol>
<li>List the tables from Typhoon variables.</li>
<li>Extract each table from MySQL</li>
<li>Write each table to S3 in JSON<ol>
<li>Creating a function to output to JSON</li>
<li>Switching our connection to S3</li>
</ol>
</li>
<li>Copy the files into snowflake</li>
</ol>
<p><strong>DAG</strong>: <code>list_tables</code>→ <code>extract_tables</code>→ <code>write_data_S3</code>→ <code>copy_to_snowflake_stage</code></p>
<p>We will learn how to sample and test the flows as we build. Here is the final expected output: </p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dwh_flow</span>
<span class="nt">schedule_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rate(1 hours)</span>
<span class="nt">granularity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hour</span>

<span class="nt">tasks</span><span class="p">:</span>
  <span class="nt">list_tables</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.flow_control.branch</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">branches</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">clients</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sales</span>

  <span class="nt">extract_tables</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">list_tables</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.relational.execute_query</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Hook</span> <span class="l l-Scalar l-Scalar-Plain">transaction_db</span>
      <span class="nt">batch_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="nt">query_params</span><span class="p">:</span>
        <span class="nt">interval_start</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$DAG_CONTEXT.interval_start</span>
        <span class="nt">interval_end</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$DAG_CONTEXT.interval_end</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="nt">table_name</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
      <span class="nt">query</span><span class="p">:</span> <span class="kt">!MultiStep</span>
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">table_name=$BATCH</span>
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;SELECT * FROM {table_name} where creation_timestamp between %(interval_start)s and %(interval_end)s&quot;</span>

  <span class="nt">write_data_S3</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">extract_tables</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.write_data</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.data_lake</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">transformations.data.list_of_tuples_to_json(list($BATCH.batch), $BATCH.columns)</span>
      <span class="nt">path</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;data_{$BATCH.metadata[&#39;table_name&#39;]}_batch_num_&quot; + str($BATCH_NUM) + &quot;_&quot; + str($DAG_CONTEXT.interval_end).replace(&quot;:&quot;, &quot;_&quot;) + &quot;.json&quot;</span>
      <span class="nt">metadata</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH.metadata</span>

  <span class="nt">copy_to_snowflake_stage</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write_data_S3</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.snowflake.copy_into</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.snowflake</span>
      <span class="nt">table</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH.metadata[&#39;table_name&#39;]</span>
      <span class="nt">stage_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stagetestcorpdatalake</span>
      <span class="nt">s3_path</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
</code></pre></div>
<p>Lets create a file in the /my_project_root/dags folder called <code>dwh_flow.yml</code> .</p>
<h2 id="list_tables">List_tables</h2>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dwh_flow</span>
<span class="nt">schedule_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rate(1 hours)</span>
<span class="nt">add granularity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hour</span>

<span class="nt">tasks</span><span class="p">:</span>
  <span class="nt">list_tables</span><span class="p">:</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.flow_control.branch</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">branches</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">clients</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sales</span>

  <span class="nt">echo_my_tables</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">list_tables</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.debug.echo</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">mydata</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
</code></pre></div>
<p><em>Life is simple when you only have two tables - if only!</em></p>
<p>Let's extract these hourly. We will improve this with variables later. </p>
<p>Let's run <code>typhoon status</code>, build it and run it:</p>
<p><code>typhoon dag build dwh_flow</code></p>
<p><code>typhoon dag run --dag-name dwh_flow</code></p>
<p><img alt="typhoon cli run_1" src="img/mysql_to_snowflake_1.png" /></p>
<p>You can see we are simply outputting the tables in the list. </p>
<h2 id="extracting-from-mysql">Extracting from MySQL</h2>
<div class="highlight"><pre><span></span><code>  <span class="nt">extract_tables</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">list_tables</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.relational.execute_query</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.transaction_db</span>
      <span class="nt">batch_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="nt">table_name</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
      <span class="nt">query</span><span class="p">:</span> <span class="kt">!Py</span> <span class="s">&quot;SELECT</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">FROM</span><span class="nv"> </span><span class="s">{table_name}&quot;</span><span class="l l-Scalar l-Scalar-Plain">.format(table_name=$BATCH)</span>
</code></pre></div>
<p>Ok, here there are a few things going on:</p>
<ol>
<li>We are applying <code>relational.execute_query</code> on each table to query on our <code>$HOOK.transaction_db</code> connection. This is pointing to our MySQL database that records our customer transactions. </li>
<li>We are saving the table names for use downstream in the flow in our <code>metadata</code> dictionary.</li>
<li>We are formatting our <code>query</code> using normal python. Again, later in this tutorial we will use <strong><em>Variables</em></strong> to store our dynamic SQL<strong><em>.</em></strong></li>
</ol>
<p>Ok, so we will output the whole table each hour. Perhaps <em>not so smart</em>, so lets add something more reasonable. </p>
<div class="highlight"><pre><span></span><code><span class="nt">extract_tables</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">list_tables</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.relational.execute_query</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Hook</span> <span class="l l-Scalar l-Scalar-Plain">echodb</span>
      <span class="nt">batch_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="nt">query_params</span><span class="p">:</span>
        <span class="nt">interval_start</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$DAG_CONTEXT.interval_start</span>
        <span class="nt">interval_end</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$DAG_CONTEXT.interval_end</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="nt">table_name</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH</span>
      <span class="nt">query</span><span class="p">:</span> <span class="kt">!MultiStep</span>
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">table_name=$BATCH</span>
        <span class="p p-Indicator">-</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;SELECT * FROM {table_name} where creation_timestamp between %(interval_start)s and %(interval_end)s&quot;</span>
</code></pre></div>
<p>Here we are making two changes. The obvious one is to apply the <code>$DAG_CONTEXT.interval_start</code> and <code>$DAG_CONTEXT.interval_end</code> as query parameters in the query (note its MySQL paramstyle). This means we will pull those transactions created within the hour interval. Much more sensible!</p>
<p>Note: you could of course treat this like the table as a string format (but not the other way around; you cannot use query parameters for the table or schema).  </p>
<p>The second thing is we are <strong><em>temporarily</em></strong> using a new hook: <code>echodb</code>. This is similar to our echo task but will show us the sql that would be passed to MySQL. We need to add the connection (make sure its in the connection.yml which is available to copy at the bottom).</p>
<p><code>typhoon connection add --conn-id echodb --conn-env local</code></p>
<p><img alt="typhoon cli run_2" src="img/mysql_to_snowflake_2.png" /></p>
<p>Looks correct SQL. </p>
<p>Remember to change your hook back to 
    <code>hook: !Py $HOOK.transaction_db</code></p>
<p>Lets add our Mysql hook and run to an echo task: </p>
<p><code>typhoon connection add --conn-id transaction_db --conn-env prod</code></p>
<p>Because we are developing we might want to select a specific execution date:</p>
<p><code>typhoon dag build dwh_flow</code></p>
<p><code>typhoon status</code></p>
<p><code>typhoon dag run --dag-name dwh_flow --execution-date 2021-05-20T14:00:00</code></p>
<p><img alt="typhoon cli run_3" src="img/mysql_to_snowflake_3.png" /></p>
<p>Our (faked) data from the MySql echoed </p>
<p>Do so now its outputting our selected tables within the time interval in batches of 10 rows (of course you would raise this). Next lets land this in files to S3. </p>
<h2 id="write-each-table-to-s3-in-json">Write each table to S3 in JSON</h2>
<div class="highlight"><pre><span></span><code><span class="nt">write_data_S3</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">extract_tables</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.filesystem.write_data</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.data_lake</span>
      <span class="nt">data</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH.batch</span>
      <span class="nt">path</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">f&quot;data_{$BATCH.metadata[&#39;table_name&#39;]}_batch_num_&quot; + str($BATCH_NUM) + &quot;_&quot; + str($DAG_CONTEXT.ts).replace(&quot;:&quot;, &quot;_&quot;) + &quot;.json&quot;</span>
      <span class="nt">metadata</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH.metadata</span>
</code></pre></div>
<p><em>Ok, now its starting to look familiar (I hope).</em></p>
<p>Our function <code>filesystem.write_data</code> will write to a filesystem. Notice this is the <strong><em>same</em></strong> connection YAML used in hello_world. All our functions, connections and components are re-usable. Lets start with the local environment to test it to a local filepath. </p>
<p><code>typhoon connection add --conn-id data_lake --conn-env **local**</code></p>
<p>Running this we should now see the following (see the connection for where this will land):</p>
<p><img alt="typhoon cli run_4" src="img/mysql_to_snowflake_4.png" /></p>
<p>So we must transform the data to bytes. In fact we need to write it into JSON so that we can use Snowflake's VARIANT column for ingestion. We strongly recommend this pattern. We are passing this function data from the <code>extract_tables</code> task above. MySQL outputs some tuples so we need a transformation function that will turn these tuples into JSON (1 JSON object per row). </p>
<h2 id="optional-reating-a-function-to-output-to-json">(Optional) reating a function to output to JSON</h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>This step is optional as it already is included in typhoon. So its only to illustrate how to roll your own function.</p>
</div>
<p>So, let's make our own function for this. In the transformations folder we can add function to the data file (or you can make a new one):</p>
<p><img alt="typhoon cli run_5" src="img/mysql_to_snowflake_5.png" /></p>
<p>Typhoon is easily extensible.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">list_of_tuples_to_json</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">field_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>    
    <span class="n">list_of_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="n">tup</span><span class="p">))</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="n">d_out</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">list_of_dicts</span><span class="p">:</span>
        <span class="n">d_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">TestEncoder</span><span class="p">,</span> <span class="n">namedtuple_as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">d_out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d_out</span>
</code></pre></div>
<p>Then we can call this in the DAG by replacing <code>data</code> with:</p>
<p><code>data: !Py transformations.data.list_of_tuples_to_json(list($BATCH.batch), $BATCH.columns)</code></p>
<p>So now, before we write to the file we are transforming our tuples to return rows of json doc as bytes. </p>
<p>Building and running the DAG now gives us:</p>
<p><img alt="typhoon cli run_6" src="img/mysql_to_snowflake_6.png" /></p>
<p>So lets see how we can debug the Python code directly. One key advantage of developing in Typhoon is that the YAML compiles to very readable, normal python functions. You can debug in an IDE of your choice as normal or run from prompt.</p>
<p><img alt="typhoon cli run_7" src="img/mysql_to_snowflake_7.png" /></p>
<p>Building a DAG compiles to the 'out' folder</p>
<p>Note that we can set the example task to debug with in <strong><code>dwh_flow.py</code></strong>. For example here we are setting a test execution date. by altering the example_event datetime. </p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="o">**</span><span class="n">example_event</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2021-05-20T14:00:00Z&#39;</span>
    <span class="p">}</span><span class="o">**</span>
    <span class="n">example_event_task</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;task&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dag_name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;list_tables_branches&#39;</span><span class="p">,</span>
        <span class="s1">&#39;trigger&#39;</span><span class="p">:</span> <span class="s1">&#39;dag&#39;</span><span class="p">,</span>
        <span class="s1">&#39;attempt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;dag_context&#39;</span><span class="p">:</span> <span class="n">DagContext</span><span class="o">.</span><span class="n">from_cron_and_event_time</span><span class="p">(</span>
                <span class="n">schedule_interval</span><span class="o">=</span><span class="s1">&#39;rate(1 hours)&#39;</span><span class="p">,</span>
                <span class="n">event_time</span><span class="o">=</span><span class="n">example_event</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="n">granularity</span><span class="o">=</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">dwh_flow_main</span><span class="p">(</span><span class="n">example_event</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p>We can find the point in the code that is relevant for our JSON</p>
<div class="highlight"><pre><span></span><code><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">list_of_tuples_to_json</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">),</span> <span class="n">batch</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</code></pre></div>
<p>So you can develop your function to correctly encode the datetime: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">DateTimeEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;isoformat&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_of_tuples_to_json</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">field_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">list_of_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="n">tup</span><span class="p">))</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="n">d_out</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">list_of_dicts</span><span class="p">:</span>
        <span class="n">d_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">DateTimeEncoder</span><span class="p">,</span> <span class="n">namedtuple_as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">d_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">d_out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d_out</span>
</code></pre></div>
<p>Then we should add this to our YAML:</p>
<p><code>data: !Py transformations.data.list_of_tuples_to_json(list($BATCH.batch), $BATCH.columns)</code></p>
<p>This is passing $BATCH.batch and the $BATCH.columns to this function that we will add. It is very simply transforming tuples from the resultset to JSON using our new function above. </p>
<p>Now if we run it again, either in the cli or the <strong><code>dwh_flow.py</code></strong> directly we should get an output to our local filesystem like:</p>
<p><img alt="typhoon cli run_8" src="img/mysql_to_snowflake_8.png" /></p>
<p>Our (fake) data exported as JSON in batches of 10 rows</p>
<h2 id="switching-to-s3">Switching to S3</h2>
<p>The final step of this section is to switch the connection to our S3 bucket (i.e. production): </p>
<p><code>typhoon connection add --conn-id data_lake --conn-env **prod**</code></p>
<p>When we re-run the DAG we will see the results are now landing in S3 (see YAML connections at end of this for hints on getting the connection right). </p>
<p><img alt="typhoon cli run_9" src="img/mysql_to_snowflake_9.png" /></p>
<p>And in the bucket :</p>
<p><img alt="typhoon cli run_10" src="img/mysql_to_snowflake_10.png" /></p>
<h2 id="copy-data-to-snowflake">Copy data to Snowflake</h2>
<p>Ok, now for the final step - we need to upload these files to snowflake. To prepare snowflake to receive from S3 <a href="https://docs.snowflake.com/en/user-guide/data-load-s3-config.html">you need to set up an S3 Stage</a> <a href="https://docs.snowflake.com/en/user-guide/data-load-s3-config.html">( See Snowflake docs)</a>.</p>
<p>Let's add our final task to the DAG YAML:</p>
<div class="highlight"><pre><span></span><code><span class="nt">copy_to_snowflake_stage</span><span class="p">:</span>
    <span class="nt">input</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">write_data_S3</span>
    <span class="nt">function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">typhoon.snowflake.copy_into</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">hook</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$HOOK.snowflake</span>
      <span class="nt">table</span><span class="p">:</span> <span class="kt">!Py</span> <span class="l l-Scalar l-Scalar-Plain">$BATCH.metadata[&#39;table_name&#39;]</span>
      <span class="nt">stage_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stagetestcorpdatalake</span>
      <span class="nt">s3_path</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
</code></pre></div>
<p>Before we run it we need to create our staging tables. We are using a VARIANT loading field to land the data: </p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">TABLE</span> <span class="n">clients</span> <span class="p">(</span>
    <span class="n">data_var</span> <span class="n">variant</span><span class="p">,</span>
    <span class="n">etl_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">etl_timestamp</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">etl_filename</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">;</span>

<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">TABLE</span> <span class="n">sales</span> <span class="p">(</span>
    <span class="n">data_var</span> <span class="n">variant</span><span class="p">,</span>
    <span class="n">etl_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
    <span class="n">etl_timestamp</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">etl_filename</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">;</span>
</code></pre></div>
<p>We need to add our connection (see YAML at the end for the connection):</p>
<p><code>typhoon connection add --conn-id snowflake --conn-env prod</code></p>
<p>Now we can build our flow for the final time and run it</p>
<p><code>typhoon dag build dwh_flow</code></p>
<p><code>typhoon dag run --dag-name dwh_flow --execution-date 2021-05-20T14:00:00</code></p>
<p><strong>... and we have data in Snowflake!</strong></p>
<p><img alt="typhoon cli run_11" src="img/mysql_to_snowflake_11.png" /></p>
<div class="admonition info">
<p class="admonition-title">Some potential optimisations</p>
<ul>
<li>We are running COPY for each file we land. This isn't optimal, even though snowflake is protecting against duplicating the data. We can tackle this chaining together DAGS by writing a 'success file' .</li>
<li>Listing tables in a variable</li>
<li>More templating</li>
<li><strong>Creating a Component!</strong></li>
</ul>
</div>
<p>We will cover these in other blogs. For now...well done you made it!</p>
<p><img alt="https://images.unsplash.com/photo-1613530498905-1b17a6f40547?ixlib=rb-1.2.1&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb" src="https://images.unsplash.com/photo-1613530498905-1b17a6f40547?ixlib=rb-1.2.1&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb" /></p>
<h2 id="helper-assets">Helper Assets</h2>
<h3 id="yaml-connections">YAML connections</h3>
<div class="highlight"><pre><span></span><code><span class="nt">echo</span><span class="p">:</span>
  <span class="nt">local</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo</span>

<span class="nt">echodb</span><span class="p">:</span>
  <span class="nt">local</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echodb</span>
    <span class="nt">schema</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">main</span>

<span class="nt">data_lake</span><span class="p">:</span>
  <span class="nt">prod</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">base_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
      <span class="nt">bucket</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-bucket-here</span>
      <span class="nt">region_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-region-here</span>
      <span class="nt">login</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SECRETLOGIN</span>
      <span class="nt">passowrd</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SECRETKEY</span>

  <span class="nt">local</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local_storage</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">base_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/data_lake</span>

<span class="nt">transaction_db</span><span class="p">:</span>
  <span class="nt">dev</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqlite</span>
    <span class="nt">schema</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">main</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">database</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/web_trans_local.db</span>
  <span class="nt">prod</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqlalchemy</span>
    <span class="nt">login</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-login-name</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-password</span>
    <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
    <span class="nt">schema</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prod_web_ecom</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">dialect</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
      <span class="nt">driver</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysqldb</span>
      <span class="nt">database</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prod_web_ecom</span>

<span class="nt">snowflake</span><span class="p">:</span>
  <span class="nt">prod</span><span class="p">:</span>
    <span class="nt">conn_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">snowflake</span>
    <span class="nt">login</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-login</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-password</span>
    <span class="nt">schema</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">staging</span>
    <span class="nt">extra</span><span class="p">:</span>
      <span class="nt">account</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-account</span>
      <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-region</span>
      <span class="nt">database</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-db</span>
      <span class="nt">warehouse</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">WAREHOUSE_NAME</span>
      <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">your-role</span>
</code></pre></div>
<h3 id="mock-data">Mock data</h3>
<p><a href="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b609b5d1-6ed0-4803-9d94-eedd1cb248f7/Sample_MySQL_Data.zip">Sample MySQL Data.zip</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="hello-world.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Hello World" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Hello World
            </div>
          </div>
        </a>
      
      
        
        <a href="pandas-examples.html" class="md-footer__link md-footer__link--next" aria-label="Next: Pandas automation" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Pandas automation
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>